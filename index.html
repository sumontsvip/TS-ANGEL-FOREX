<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>📈 TS Angel Signal System</title>
</head>
<body style="font-family: Arial, sans-serif; background: #f2f2f2; padding: 20px;">

  <h2>📊 TS Angel - Real-Time Signal Bot</h2>

  <label for="pairSelect">Select Pair:</label>
  <select id="pairSelect">
    <option value="XAUUSD">XAUUSD</option>
    <option value="BTCUSD">BTCUSD</option>
  </select>
  <button onclick="generateSignal()">Generate Signal</button>

  <div id="signalBox" style="margin-top: 20px; padding: 15px; background: #fff; border-radius: 5px;"></div>

  <!-- ✅ TradingView Chart -->
  <div style="margin-top: 40px;">
    <h3>📉 Live Chart for Drawing:</h3>
    <div class="tradingview-widget-container">
      <div id="tradingview_chart" style="height:500px;"></div>
    </div>
  </div>

  <!-- ✅ Script -->
  <script>
    let activeSignal = null;
    const signalBox = document.getElementById("signalBox");
    const pairSelect = document.getElementById("pairSelect");

    async function fetchLivePrice(pair) {
      try {
        const url = `https://api.binance.com/api/v3/ticker/price?symbol=${pair}`;
        const response = await fetch(url);
        const data = await response.json();
        return parseFloat(data.price);
      } catch (err) {
        signalBox.innerHTML = "❌ Error fetching price.";
        speak("Error fetching price");
        return null;
      }
    }

    async function generateSignal() {
      const now = new Date();
      const pair = pairSelect.value;
      const day = now.getDay();
      const time = now.toLocaleTimeString("en-IN", { hour12: true });

      if (activeSignal) {
        const msg = "⏳ Wait: A signal is already active!";
        signalBox.innerHTML = msg;
        speak(msg);
        return;
      }

      if ((pair === "XAUUSD") && (day === 6 || day === 0)) {
        const msg = "⚠️ Gold market is closed today.";
        signalBox.innerHTML = msg;
        speak(msg);
        return;
      }

      const price = await fetchLivePrice(pair === "XAUUSD" ? "XAUUSDT" : "BTCUSDT");
      if (!price) return;

      if (pair === "XAUUSD") {
        const dailyBias = price > 3350.5 ? "BUY" : "SELL";
        const momentumSell = price < 3377.28;
        const momentumBuy = price > 3377.28;
        const entryZones = momentumSell ? [3372, 3370, 3365, 3360, 3356, 3351] : [3381, 3385, 3389, 3394];
        const inZone = entryZones.some(level => Math.abs(price - level) <= 0.5);

        if (!inZone) {
          const msg = `❌ No valid trade setup now.\nPrice not near any key zone.\nCurrent: ${price}`;
          signalBox.innerHTML = msg.replace(/\n/g, '<br>');
          speak("No trade now. Price not near level zone.");
          return;
        }

        const direction = momentumSell ? "SELL" : "BUY";
        const entry = parseFloat(price.toFixed(2));
        const tp1 = direction === "BUY" ? (entry + 5).toFixed(2) : (entry - 5).toFixed(2);
        const tp2 = direction === "BUY" ? (entry + 10).toFixed(2) : (entry - 10).toFixed(2);
        const tp3 = direction === "BUY" ? (entry + 15).toFixed(2) : (entry - 15).toFixed(2);
        const sl = direction === "BUY" ? (entry - 4).toFixed(2) : (entry + 4).toFixed(2);

        activeSignal = { pair, direction, entry, tp1, tp2, tp3, sl, time, mode: "Intraday", status: "Running" };

        const signalText =
          `📊 ${pair}: ${direction}\n⚙️ Mode: Intraday\n🟡 Entry: ${entry}\n🎯 TP1: ${tp1} | TP2: ${tp2} | TP3: ${tp3}\n🛑 SL: ${sl}\n📍 Live Price: ${price}\n📈 Trade is live...`;

        signalBox.innerHTML = signalText.replace(/\n/g, "<br>");
        speak(`${pair} ${direction}. Entry ${entry}. TP1 ${tp1}, TP2 ${tp2}, SL ${sl}`);
      } else {
        signalBox.innerHTML = "⚠️ BTC signal logic not updated yet.";
        speak("BTC logic coming soon.");
      }
    }

    function speak(text) {
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = "bn-BD";
      msg.pitch = 1.3; // more feminine
      msg.rate = 0.93;
      msg.voice = speechSynthesis.getVoices().find(v => v.lang.includes("bn") && v.name.toLowerCase().includes("female"));
      speechSynthesis.speak(msg);
    }

    // Load voices properly
    window.speechSynthesis.onvoiceschanged = () => {};
  </script>

  <!-- ✅ TradingView Script -->
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
  <script type="text/javascript">
    new TradingView.widget({
      "width": "100%",
      "height": 500,
      "symbol": "OANDA:XAUUSD",
      "interval": "5",
      "timezone": "Asia/Kolkata",
      "theme": "light",
      "style": "1",
      "locale": "en",
      "toolbar_bg": "#f1f3f6",
      "enable_publishing": false,
      "hide_top_toolbar": false,
      "withdateranges": true,
      "hide_side_toolbar": false,
      "allow_symbol_change": true,
      "details": true,
      "studies": [],
      "container_id": "tradingview_chart"
    });
  </script>

</body>
</html>
